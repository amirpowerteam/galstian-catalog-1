<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apply Release Video URLs</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111;padding:24px;}button{padding:12px 18px;font-size:16px}</style>
</head>
<body>
  <h1>اعمال لینک‌های ویدیو از Release</h1>
  <p>این صفحه لینک‌های ویدیو را در IndexedDB برنامه می‌نویسد و سپس به صفحهٔ اصلی اپ برمی‌گردد.</p>
  <p><strong>نکته:</strong> این صفحه باید روی همان origin (مثلاً GitHub Pages) باز شود تا بتواند IndexedDB اپ را به‌روزرسانی کند.</p>
  <button id="apply">اعمال لینک‌ها و بازگشت به اپ</button>
  <pre id="log" style="margin-top:12px;color:#444"></pre>

  <script>
  (function(){
    const base = 'https://github.com/amirpowerteam/galstian-catalog-1/releases/download/v1.0.0-deploy/';
    const welcomeUrl = base + 'boloc2.mp4';
    const heroUrl = base + 'boloc3.mp4';
    const log = (s)=>{document.getElementById('log').textContent += s + '\n';};

    async function applyAndRedirect(){
      try{
        log('Setting URLs (merge mode)...');
        // Merge mode: preserve existing hero heading/body and do not force background type.
        if (typeof dbPut === 'function' && typeof dbGet === 'function' && typeof STORES !== 'undefined'){
          const existingHero = (await dbGet(STORES.CONFIG, 'hero_media_block'))?.value || {};
          const mergedHero = Object.assign({}, existingHero, { mediaType: 'video', mediaUrl: heroUrl });
          await dbPut(STORES.CONFIG, { key: 'welcome_video', value: welcomeUrl });
          await dbPut(STORES.CONFIG, { key: 'welcome_background_video', value: welcomeUrl });
          await dbPut(STORES.CONFIG, { key: 'hero_media_block', value: mergedHero });
          log('Config updated via dbPut (merged).');
        } else {
          const openDB = (name, version=1) => new Promise((res,rej)=>{
            const rq = indexedDB.open(name, version);
            rq.onsuccess = ()=>res(rq.result);
            rq.onerror = ()=>rej(rq.error);
            rq.onupgradeneeded = ()=>{
              const db = rq.result;
              if (!db.objectStoreNames.contains('config')) db.createObjectStore('config', { keyPath: 'key' });
            };
          });
          const db = await openDB('PortableCatalogDB_Lazy_V1',1);
          const tx = db.transaction('config','readwrite');
          const s = tx.objectStore('config');
          // read existing hero and merge
          const g = s.get('hero_media_block');
          g.onsuccess = ()=>{
            const cur = g.result ? g.result.value || {} : {};
            const merged = Object.assign({}, cur, { mediaType: 'video', mediaUrl: heroUrl });
            try{
              s.put({ key: 'welcome_video', value: welcomeUrl });
              s.put({ key: 'welcome_background_video', value: welcomeUrl });
              s.put({ key: 'hero_media_block', value: merged });
            }catch(e){ log('Write error: '+e); }
          };
          g.onerror = (e)=>{ log('Read hero_media_block failed: '+(e && e.message)); };
          await new Promise((res,rej)=>{ tx.oncomplete = res; tx.onerror = rej; });
          log('IndexedDB config updated (merged).');
        }
        log('Redirecting to app...');
        setTimeout(()=>{ location.href = './'; }, 700);
      } catch(e){ log('Error: '+(e && e.message) || e); console.error(e); }
    }

    document.getElementById('apply').addEventListener('click', applyAndRedirect, { once:true });
  })();
  </script>
</body>
</html>
